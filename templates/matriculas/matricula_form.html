{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/matricula_form.css') }}">


<div class="page-header">
    <div class="container">
        <h1 class="page-title">
            <i class="fas fa-user-graduate"></i>
            {% if matricula %}Editar{% else %}Nueva{% endif %} Matrícula
        </h1>
        <p class="page-subtitle">
            {% if matricula %}
                Modificar la información de la matrícula existente
            {% else %}
                Registrar una nueva matrícula en el sistema
            {% endif %}
        </p>
    </div>
</div>

<div class="container">
    <div class="form-container">
        <h2 class="form-title">
            <i class="fas fa-{% if matricula %}edit{% else %}plus{% endif %}"></i>
            Información de la Matrícula
        </h2>

        <!-- Información importante -->
        <div class="info-card">
            <div class="info-title">
                <i class="fas fa-info-circle"></i>
                Información importante
            </div>
            <div class="info-content">
                <ul style="margin: 0; padding-left: 1.2rem;">
                    <li>Los campos marcados con <span style="color: var(--danger-red);">*</span> son obligatorios</li>
                    <li>Un estudiante no puede tener más de una matrícula activa en el mismo año lectivo</li>
                    <li>Verifique que el estudiante esté activo antes de realizar la matrícula</li>
                </ul>
            </div>
        </div>

        <form id="matriculaForm" method="POST">
            <div class="form-grid">
                <!-- Estudiante -->
                <div class="form-group">
                    <label class="form-label required" for="id_estudiante">
                        <i class="fas fa-user"></i>
                        Estudiante
                    </label>
                    <select class="form-control form-select" id="id_estudiante" name="id_estudiante" required>
                        <option value="">Seleccionar estudiante</option>
                        {% for estudiante in estudiantes %}
                        <option value="{{ estudiante.id_estudiante }}"
                            {% if (matricula and matricula.id_estudiante == estudiante.id_estudiante) 
                                or (id_estudiante and id_estudiante == estudiante.id_estudiante) %}
                                selected
                            {% endif %}>
                            {{ estudiante.nombres }} {{ estudiante.apellidos }} 
                            {% if estudiante.nie %}- NIE: {{ estudiante.nie }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Seleccione el estudiante a matricular</div>

                    <!-- Información del estudiante seleccionado -->
                    <div class="student-info" id="studentInfo">
                        <div><strong>Información del estudiante:</strong></div>
                        <div id="studentDetails"></div>
                    </div>
                </div>

                <!-- Sección -->
                <div class="form-group">
                    <label class="form-label required" for="id_seccion">
                        <i class="fas fa-chalkboard"></i>
                        Sección
                    </label>
                    <select class="form-control form-select" id="id_seccion" name="id_seccion" required>
                        <option value="">Seleccionar sección</option>
                        {% for seccion in secciones %}
                        <option value="{{ seccion.id_seccion }}"
                            data-grado="{{ seccion.grado }}"
                            data-nivel="{{ seccion.nivel }}"
                            data-ano="{{ seccion.ano_lectivo }}"
                            data-id-grado="{{ seccion.id_grado }}"
                            {% if matricula and matricula.id_seccion == seccion.id_seccion %}selected{% endif %}>
                            {{ seccion.nombre_completo }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Seleccione la sección para la matrícula</div>
                    
                    <!-- Información de la sección seleccionada -->
                    <div class="student-info" id="sectionInfo">
                        <div><strong>Información de la sección:</strong></div>
                        <div id="sectionDetails"></div>
                    </div>
                </div>

                <!-- Fecha de Matrícula -->
                <div class="form-group">
                    <label class="form-label" for="fecha_matricula">
                        <i class="fas fa-calendar-alt"></i>
                        Fecha de Matrícula
                    </label>
                    <input type="date" 
                           class="form-control" 
                           id="fecha_matricula" 
                           name="fecha_matricula"
                           value="{{ matricula.fecha_matricula.strftime('%Y-%m-%d') if matricula and matricula.fecha_matricula else '' }}">
                    <div class="form-text">Si no se especifica, se usará la fecha actual</div>
                </div>
            </div>

            <!-- Resumen de la matrícula -->
            <div class="info-card" id="resumenCard" style="display: none;">
                <div class="info-title">
                    <i class="fas fa-clipboard-check"></i>
                    Resumen de la Matrícula
                </div>
                <div class="info-content" id="resumenContent"></div>
            </div>

            <div class="form-actions">
                <a href="{{ url_for('matricula.lista_matriculas') }}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Volver al Listado
                </a>
                <button type="button" class="btn btn-cancel" onclick="clearForm()">
                    <i class="fas fa-times"></i>
                    Limpiar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    {% if matricula %}Actualizar{% else %}Guardar{% endif %} Matrícula
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Datos de estudiantes para mostrar información
    const estudiantesData = {
        {% for estudiante in estudiantes %}
        {{ estudiante.id_estudiante }}: {
            nombres: "{{ estudiante.nombres }}",
            apellidos: "{{ estudiante.apellidos }}",
            nie: "{{ estudiante.nie or 'No registrado' }}",
            fecha_nacimiento: "{{ estudiante.fecha_nacimiento.strftime('%d/%m/%Y') if estudiante.fecha_nacimiento else 'No registrada' }}",
            genero: "{{ 'Masculino' if estudiante.genero == 'M' else 'Femenino' if estudiante.genero == 'F' else 'No especificado' }}",
            telefono: "{{ estudiante.telefono or 'No registrado' }}",
            activo: {{ 'true' if estudiante.activo else 'false' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    // Mostrar información del estudiante seleccionado
    document.getElementById('id_estudiante').addEventListener('change', function() {
        const studentId = this.value;
        const studentInfo = document.getElementById('studentInfo');
        const studentDetails = document.getElementById('studentDetails');
        
        // Limpiar el div de estado previo
        const estadoDiv = document.getElementById('estadoEstudiante');
        if (estadoDiv) {
            estadoDiv.remove();
        }
        
        // Habilitar el botón por defecto al cambiar estudiante
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.style.opacity = '1';
            submitButton.style.cursor = 'pointer';
            submitButton.title = '';
        }
        
        if (studentId && estudiantesData[studentId]) {
            const estudiante = estudiantesData[studentId];
            studentDetails.innerHTML = `
                <div><strong>Nombre:</strong> ${estudiante.nombres} ${estudiante.apellidos}</div>
                <div><strong>NIE:</strong> ${estudiante.nie}</div>
                <div><strong>Fecha Nacimiento:</strong> ${estudiante.fecha_nacimiento}</div>
                <div><strong>Género:</strong> ${estudiante.genero}</div>
                <div><strong>Teléfono:</strong> ${estudiante.telefono}</div>
                <div><strong>Estado:</strong> <span style="color: ${estudiante.activo ? 'green' : 'red'}">${estudiante.activo ? 'Activo' : 'Inactivo'}</span></div>
            `;
            studentInfo.classList.add('active');
            
            // Verificar estado si ya hay una sección seleccionada
            const seccionSelect = document.getElementById('id_seccion');
            if (seccionSelect.value) {
                verificarEstadoEstudiante(studentId, seccionSelect.options[seccionSelect.selectedIndex]);
            }
        } else {
            studentInfo.classList.remove('active');
        }
        updateResumen();
    });

    // Mostrar información de la sección seleccionada
    document.getElementById('id_seccion').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const sectionInfo = document.getElementById('sectionInfo');
        const sectionDetails = document.getElementById('sectionDetails');
        
        // Limpiar el div de estado previo al cambiar sección
        const estadoDiv = document.getElementById('estadoEstudiante');
        if (estadoDiv) {
            estadoDiv.remove();
        }
        
        // Habilitar el botón por defecto al cambiar sección
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.style.opacity = '1';
            submitButton.style.cursor = 'pointer';
            submitButton.title = '';
        }
        
        if (this.value) {
            const grado = selectedOption.getAttribute('data-grado');
            const nivel = selectedOption.getAttribute('data-nivel');
            const ano = selectedOption.getAttribute('data-ano');
            
            sectionDetails.innerHTML = `
                <div><strong>Grado:</strong> ${grado} - ${nivel}</div>
                <div><strong>Año Lectivo:</strong> ${ano}</div>
                <div><strong>Sección:</strong> ${selectedOption.text}</div>
            `;
            sectionInfo.classList.add('active');
            
            // Verificar estado del estudiante si ya hay uno seleccionado
            const estudianteSelect = document.getElementById('id_estudiante');
            if (estudianteSelect.value) {
                verificarEstadoEstudiante(estudianteSelect.value, selectedOption);
            }
        } else {
            sectionInfo.classList.remove('active');
        }
        updateResumen();
    });

    // Función para verificar el estado del estudiante
    async function verificarEstadoEstudiante(idEstudiante, seccionOption) {
        const ano = seccionOption.getAttribute('data-ano');
        const idSeccion = seccionOption.value;
        const studentInfo = document.getElementById('studentInfo');
        
        // Obtener el grado de la sección seleccionada
        let idGrado = null;
        try {
            // Buscar el id_grado desde las opciones de sección
            const seccionData = {{ secciones|tojson }};
            const seccionSeleccionada = seccionData.find(s => s.id_seccion == idSeccion);
            if (seccionSeleccionada) {
                // Necesitamos obtener el id_grado desde el servidor
                // Por ahora lo hacemos con una llamada adicional o lo agregamos a data-attributes
            }
        } catch (e) {
            console.log("No se pudo obtener id_grado", e);
        }
        
        try {
            let url = `{{ url_for('matricula.verificar_estado_estudiante', id_estudiante=0) }}`.replace('0', idEstudiante) + `?ano_lectivo=${ano}`;
            
            // Agregar id_grado si está disponible en el data attribute
            const idGradoAttr = seccionOption.getAttribute('data-id-grado');
            if (idGradoAttr) {
                url += `&id_grado=${idGradoAttr}`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success) {
                let estadoHtml = '<div style="margin-top: 10px; padding: 10px; border-radius: 5px; border-left: 4px solid ';
                
                if (data.tiene_registro_anterior) {
                    if (data.estado_final === 'Aprobado') {
                        estadoHtml += data.puede_matricularse ? '#28a745;"> <strong style="color: #28a745;">✅ Estado Aprobado</strong>' : '#dc3545;"> <strong style="color: #dc3545;">❌ Grado Incompatible</strong>';
                    } else if (data.estado_final === 'Reprobado') {
                        estadoHtml += data.puede_matricularse ? '#ffc107;"> <strong style="color: #856404;">⚠️ Repitiendo Grado</strong>' : '#dc3545;"> <strong style="color: #dc3545;">❌ Estado Reprobado</strong>';
                    } else if (data.estado_final === 'Pendiente') {
                        estadoHtml += '#ffc107;"> <strong style="color: #856404;">⏳ Estado Pendiente</strong>';
                    } else {
                        estadoHtml += '#6c757d;"> <strong style="color: #6c757d;">⚠️ Sin Evaluar</strong>';
                    }
                    
                    estadoHtml += `
                        <div style="margin-top: 8px; font-size: 0.9em;">
                            <div><strong>Año Anterior:</strong> ${data.ano_anterior}</div>
                            <div><strong>Grado Anterior:</strong> ${data.grado_anterior}</div>
                            <div><strong>Conducta:</strong> ${data.conducta_final}</div>
                            ${data.asistencia_final ? `<div><strong>Asistencia:</strong> ${data.asistencia_final.toFixed(2)}%</div>` : ''}
                        </div>
                        <div style="margin-top: 8px; font-style: italic; ${data.puede_matricularse ? 'color: #28a745;' : 'color: #dc3545;'}">${data.mensaje}</div>
                    `;
                } else {
                    estadoHtml += '#17a2b8;"> <strong style="color: #117a8b;">ℹ️ Nuevo Estudiante</strong>';
                    estadoHtml += `<div style="margin-top: 8px; font-style: italic;">${data.mensaje}</div>`;
                }
                
                estadoHtml += '</div>';
                
                // Limpiar y actualizar el div de estado
                let estadoDiv = document.getElementById('estadoEstudiante');
                if (!estadoDiv) {
                    // Crear el div si no existe
                    estadoDiv = document.createElement('div');
                    estadoDiv.id = 'estadoEstudiante';
                    document.getElementById('studentDetails').appendChild(estadoDiv);
                }
                // Siempre actualizar el contenido (reemplazar, no agregar)
                estadoDiv.innerHTML = estadoHtml;
                
                // Deshabilitar el botón de envío si no puede matricularse
                const submitButton = document.querySelector('button[type="submit"]');
                if (!data.puede_matricularse) {
                    submitButton.disabled = true;
                    submitButton.style.opacity = '0.5';
                    submitButton.style.cursor = 'not-allowed';
                    submitButton.title = 'No se puede matricular debido al estado del estudiante';
                } else {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                    submitButton.style.cursor = 'pointer';
                    submitButton.title = '';
                }
            }
        } catch (error) {
            console.error('Error al verificar estado:', error);
        }
    }

    // Función para actualizar el resumen
    function updateResumen() {
        const estudianteSelect = document.getElementById('id_estudiante');
        const seccionSelect = document.getElementById('id_seccion');
        const resumenCard = document.getElementById('resumenCard');
        const resumenContent = document.getElementById('resumenContent');
        
        const estudianteText = estudianteSelect.options[estudianteSelect.selectedIndex]?.text || 'No seleccionado';
        const seccionText = seccionSelect.options[seccionSelect.selectedIndex]?.text || 'No seleccionada';
        
        if (estudianteSelect.value && seccionSelect.value) {
            resumenContent.innerHTML = `
                <div><strong>Estudiante:</strong> ${estudianteText}</div>
                <div><strong>Sección:</strong> ${seccionText}</div>
            `;
            resumenCard.style.display = 'block';
        } else {
            resumenCard.style.display = 'none';
        }
    }

    // Función para limpiar el formulario
    function clearForm() {
        if (confirm('¿Está seguro de que desea limpiar el formulario? Se perderán todos los datos ingresados.')) {
            document.getElementById('matriculaForm').reset();
            document.getElementById('studentInfo').classList.remove('active');
            document.getElementById('sectionInfo').classList.remove('active');
            document.getElementById('resumenCard').style.display = 'none';
        }
    }

    // Validación y envío del formulario
    document.getElementById('matriculaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validaciones básicas del cliente
        const estudiante = document.getElementById('id_estudiante').value;
        const seccion = document.getElementById('id_seccion').value;
        
        if (!estudiante || !seccion) {
            Swal.fire({
                title: 'Campos incompletos',
                text: 'Por favor, complete todos los campos obligatorios.',
                icon: 'warning',
                confirmButtonColor: '#0D2C63'
            });
            return;
        }

        // Mostrar confirmación
        const result = await Swal.fire({
            title: '{% if matricula %}Actualizar{% else %}Crear{% endif %} Matrícula',
            text: '¿Está seguro de que desea {% if matricula %}actualizar{% else %}crear{% endif %} esta matrícula?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#059669',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sí, {% if matricula %}actualizar{% else %}crear{% endif %}',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            // Enviar formulario
            const formData = new FormData(this);
            
            try {
                const response = await fetch('{{ request.path }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    await Swal.fire({
                        title: '¡Éxito!',
                        text: data.mensaje,
                        icon: 'success',
                        confirmButtonColor: '#0D2C63'
                    });
                    
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    }
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.mensaje,
                        icon: 'error',
                        confirmButtonColor: '#0D2C63'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error de conexión',
                    text: 'No se pudo completar la operación. Por favor, intente nuevamente.',
                    icon: 'error',
                    confirmButtonColor: '#0D2C63'
                });
            }
        }
    });

    // Inicializar resumen si estamos editando
    {% if matricula %}
    document.addEventListener('DOMContentLoaded', function() {
        updateResumen();
        // Disparar eventos para mostrar información inicial
        document.getElementById('id_estudiante').dispatchEvent(new Event('change'));
        document.getElementById('id_seccion').dispatchEvent(new Event('change'));
    });
    {% endif %}
    // Mostrar info si ya viene seleccionado un estudiante (por URL o edición)
    document.addEventListener('DOMContentLoaded', function () {
        const estudianteSelect = document.getElementById('id_estudiante');
        if (estudianteSelect.value) {
            estudianteSelect.dispatchEvent(new Event('change'));
        }

        const seccionSelect = document.getElementById('id_seccion');
        if (seccionSelect.value) {
            seccionSelect.dispatchEvent(new Event('change'));
        }
    });

</script>
{% endblock %}