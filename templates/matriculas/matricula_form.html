{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/matricula_form.css') }}">


<div class="page-header">
    <div class="container">
        <h1 class="page-title">
            <i class="fas fa-user-graduate"></i>
            {% if matricula %}Editar{% else %}Nueva{% endif %} Matr√≠cula
        </h1>
        <p class="page-subtitle">
            {% if matricula %}
                Modificar la informaci√≥n de la matr√≠cula existente
            {% else %}
                Registrar una nueva matr√≠cula en el sistema
            {% endif %}
        </p>
    </div>
</div>

<div class="container">
    <div class="form-container">
        <h2 class="form-title">
            <i class="fas fa-{% if matricula %}edit{% else %}plus{% endif %}"></i>
            Informaci√≥n de la Matr√≠cula
        </h2>

        <!-- Informaci√≥n importante -->
        <div class="info-card">
            <div class="info-title">
                <i class="fas fa-info-circle"></i>
                Informaci√≥n importante
            </div>
            <div class="info-content">
                <ul style="margin: 0; padding-left: 1.2rem;">
                    <li>Los campos marcados con <span style="color: var(--danger-red);">*</span> son obligatorios</li>
                    <li>Un estudiante no puede tener m√°s de una matr√≠cula activa en el mismo a√±o lectivo</li>
                    <li>Verifique que el estudiante est√© activo antes de realizar la matr√≠cula</li>
                </ul>
            </div>
        </div>

        <form id="matriculaForm" method="POST">
            <div class="form-grid">
                <!-- Estudiante -->
                <div class="form-group">
                    <label class="form-label required" for="id_estudiante">
                        <i class="fas fa-user"></i>
                        Estudiante
                    </label>
                    <select class="form-control form-select" id="id_estudiante" name="id_estudiante" required>
                        <option value="">Seleccionar estudiante</option>
                        {% for estudiante in estudiantes %}
                        <option value="{{ estudiante.id_estudiante }}"
                            {% if (matricula and matricula.id_estudiante == estudiante.id_estudiante) 
                                or (id_estudiante and id_estudiante == estudiante.id_estudiante) %}
                                selected
                            {% endif %}>
                            {{ estudiante.nombres }} {{ estudiante.apellidos }} 
                            {% if estudiante.nie %}- NIE: {{ estudiante.nie }}{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Seleccione el estudiante a matricular</div>

                    <!-- Informaci√≥n del estudiante seleccionado -->
                    <div class="student-info" id="studentInfo">
                        <div><strong>Informaci√≥n del estudiante:</strong></div>
                        <div id="studentDetails"></div>
                    </div>
                </div>

                <!-- Secci√≥n -->
                <div class="form-group">
                    <label class="form-label required" for="id_seccion">
                        <i class="fas fa-chalkboard"></i>
                        Secci√≥n
                    </label>
                    <select class="form-control form-select" id="id_seccion" name="id_seccion" required>
                        <option value="">Seleccionar secci√≥n</option>
                        {% for seccion in secciones %}
                        <option value="{{ seccion.id_seccion }}"
                            data-grado="{{ seccion.grado }}"
                            data-nivel="{{ seccion.nivel }}"
                            data-ano="{{ seccion.ano_lectivo }}"
                            data-id-grado="{{ seccion.id_grado }}"
                            {% if matricula and matricula.id_seccion == seccion.id_seccion %}selected{% endif %}>
                            {{ seccion.nombre_completo }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Seleccione la secci√≥n para la matr√≠cula</div>
                    
                    <!-- Informaci√≥n de la secci√≥n seleccionada -->
                    <div class="student-info" id="sectionInfo">
                        <div><strong>Informaci√≥n de la secci√≥n:</strong></div>
                        <div id="sectionDetails"></div>
                    </div>
                </div>

                <!-- Fecha de Matr√≠cula -->
                <div class="form-group">
                    <label class="form-label" for="fecha_matricula">
                        <i class="fas fa-calendar-alt"></i>
                        Fecha de Matr√≠cula
                    </label>
                    <input type="date" 
                           class="form-control" 
                           id="fecha_matricula" 
                           name="fecha_matricula"
                           value="{{ matricula.fecha_matricula.strftime('%Y-%m-%d') if matricula and matricula.fecha_matricula else '' }}">
                    <div class="form-text">Si no se especifica, se usar√° la fecha actual</div>
                </div>
            </div>

            <!-- Resumen de la matr√≠cula -->
            <div class="info-card" id="resumenCard" style="display: none;">
                <div class="info-title">
                    <i class="fas fa-clipboard-check"></i>
                    Resumen de la Matr√≠cula
                </div>
                <div class="info-content" id="resumenContent"></div>
            </div>

            <div class="form-actions">
                <a href="{{ url_for('matricula.lista_matriculas') }}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Volver al Listado
                </a>
                <button type="button" class="btn btn-cancel" onclick="clearForm()">
                    <i class="fas fa-times"></i>
                    Limpiar
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    {% if matricula %}Actualizar{% else %}Guardar{% endif %} Matr√≠cula
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Datos de estudiantes para mostrar informaci√≥n
    const estudiantesData = {
        {% for estudiante in estudiantes %}
        {{ estudiante.id_estudiante }}: {
            nombres: "{{ estudiante.nombres }}",
            apellidos: "{{ estudiante.apellidos }}",
            nie: "{{ estudiante.nie or 'No registrado' }}",
            fecha_nacimiento: "{{ estudiante.fecha_nacimiento.strftime('%d/%m/%Y') if estudiante.fecha_nacimiento else 'No registrada' }}",
            genero: "{{ 'Masculino' if estudiante.genero == 'M' else 'Femenino' if estudiante.genero == 'F' else 'No especificado' }}",
            telefono: "{{ estudiante.telefono or 'No registrado' }}",
            activo: {{ 'true' if estudiante.activo else 'false' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    // Mostrar informaci√≥n del estudiante seleccionado
    document.getElementById('id_estudiante').addEventListener('change', async function() {
        const studentId = this.value;
        const studentInfo = document.getElementById('studentInfo');
        const studentDetails = document.getElementById('studentDetails');
        
        console.log('üîÑ Estudiante cambiado:', studentId);
        
        // Limpiar el div de estado previo
        const estadoDiv = document.getElementById('estadoValidacion');
        if (estadoDiv) {
            estadoDiv.remove();
            console.log('üßπ Div de validaci√≥n eliminado');
        }
        
        // Habilitar el bot√≥n por defecto al cambiar estudiante
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.style.opacity = '1';
            submitButton.style.cursor = 'pointer';
            submitButton.title = '';
        }
        
        if (studentId && estudiantesData[studentId]) {
            const estudiante = estudiantesData[studentId];
            studentDetails.innerHTML = `
                <div><strong>Nombre:</strong> ${estudiante.nombres} ${estudiante.apellidos}</div>
                <div><strong>NIE:</strong> ${estudiante.nie}</div>
                <div><strong>Fecha Nacimiento:</strong> ${estudiante.fecha_nacimiento}</div>
                <div><strong>G√©nero:</strong> ${estudiante.genero}</div>
                <div><strong>Tel√©fono:</strong> ${estudiante.telefono}</div>
                <div><strong>Estado:</strong> <span style="color: ${estudiante.activo ? 'green' : 'red'}">${estudiante.activo ? 'Activo' : 'Inactivo'}</span></div>
            `;
            studentInfo.classList.add('active');
            
            // Cargar informaci√≥n del a√±o anterior inmediatamente
            console.log('üìö Cargando info del a√±o anterior...');
            await cargarInfoAnioAnterior(studentId);
            
            // Verificar estado si ya hay una secci√≥n seleccionada
            const seccionSelect = document.getElementById('id_seccion');
            if (seccionSelect.value) {
                console.log('üéì Hay secci√≥n seleccionada, verificando...');
                await verificarEstadoEstudiante(studentId, seccionSelect.options[seccionSelect.selectedIndex]);
            } else {
                console.log('‚ö†Ô∏è No hay secci√≥n seleccionada a√∫n');
            }
        } else {
            studentInfo.classList.remove('active');
        }
        updateResumen();
    });

    // Mostrar informaci√≥n de la secci√≥n seleccionada
    document.getElementById('id_seccion').addEventListener('change', async function() {
        const selectedOption = this.options[this.selectedIndex];
        const sectionInfo = document.getElementById('sectionInfo');
        const sectionDetails = document.getElementById('sectionDetails');
        
        console.log('üîÑ Secci√≥n cambiada:', this.value);
        
        // Limpiar el div de estado previo al cambiar secci√≥n
        const estadoDiv = document.getElementById('estadoValidacion');
        if (estadoDiv) {
            estadoDiv.remove();
        }
        
        // Habilitar el bot√≥n por defecto al cambiar secci√≥n
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.style.opacity = '1';
            submitButton.style.cursor = 'pointer';
            submitButton.title = '';
        }
        
        if (this.value) {
            const grado = selectedOption.getAttribute('data-grado');
            const nivel = selectedOption.getAttribute('data-nivel');
            const ano = selectedOption.getAttribute('data-ano');
            
            sectionDetails.innerHTML = `
                <div><strong>Grado:</strong> ${grado} - ${nivel}</div>
                <div><strong>A√±o Lectivo:</strong> ${ano}</div>
                <div><strong>Secci√≥n:</strong> ${selectedOption.text}</div>
            `;
            sectionInfo.classList.add('active');
            
            // Verificar estado del estudiante si ya hay uno seleccionado
            const estudianteSelect = document.getElementById('id_estudiante');
            if (estudianteSelect.value) {
                console.log('üë®‚Äçüéì Verificando estudiante:', estudianteSelect.value);
                await verificarEstadoEstudiante(estudianteSelect.value, selectedOption);
            } else {
                console.log('‚ö†Ô∏è No hay estudiante seleccionado');
            }
        } else {
            sectionInfo.classList.remove('active');
        }
        updateResumen();
    });

    // Funci√≥n para cargar informaci√≥n del a√±o anterior
    async function cargarInfoAnioAnterior(idEstudiante) {
        try {
            const response = await fetch(`{{ url_for('matricula.obtener_info_anio_anterior', id_estudiante=0) }}`.replace('0', idEstudiante));
            const data = await response.json();
            
            const studentDetails = document.getElementById('studentDetails');
            
            if (data.success && data.tiene_registro) {
                // Agregar informaci√≥n del a√±o anterior
                const infoAnterior = document.createElement('div');
                infoAnterior.id = 'infoAnioAnterior';
                infoAnterior.style.cssText = 'margin-top: 15px; padding: 12px; background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid #0D2C63;';
                
                let estadoColor = '#6c757d';
                let estadoIcono = '‚è≥';
                if (data.estado_final === 'Aprobado') {
                    estadoColor = '#28a745';
                    estadoIcono = '‚úÖ';
                } else if (data.estado_final === 'Reprobado') {
                    estadoColor = '#dc3545';
                    estadoIcono = '‚ùå';
                }
                
                infoAnterior.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px; color: #0D2C63;">üìö Historial Acad√©mico</div>
                    <div style="font-size: 0.9em;">
                        <div><strong>√öltimo A√±o Cursado:</strong> ${data.ano_anterior}</div>
                        <div><strong>Grado:</strong> ${data.grado_nombre}</div>
                        <div><strong>Estado Final:</strong> <span style="color: ${estadoColor}; font-weight: bold;">${estadoIcono} ${data.estado_final || 'Pendiente'}</span></div>
                    </div>
                `;
                
                studentDetails.appendChild(infoAnterior);
            } else if (data.success && !data.tiene_registro) {
                // Es un estudiante nuevo
                const infoAnterior = document.createElement('div');
                infoAnterior.id = 'infoAnioAnterior';
                infoAnterior.style.cssText = 'margin-top: 15px; padding: 12px; background-color: #e7f3ff; border-radius: 5px; border-left: 4px solid #17a2b8;';
                
                infoAnterior.innerHTML = `
                    <div style="font-weight: bold; color: #117a8b;">‚ÑπÔ∏è Estudiante Nuevo</div>
                    <div style="font-size: 0.9em; margin-top: 5px;">Sin matr√≠culas en a√±os anteriores</div>
                `;
                
                studentDetails.appendChild(infoAnterior);
            }
        } catch (error) {
            console.error('Error al cargar informaci√≥n del a√±o anterior:', error);
        }
    }

    // Funci√≥n para verificar el estado del estudiante
    async function verificarEstadoEstudiante(idEstudiante, seccionOption) {
        const ano = seccionOption.getAttribute('data-ano');
        const idSeccion = seccionOption.value;
        const studentInfo = document.getElementById('studentInfo');
        
        console.log('üîç Verificando estado del estudiante:', idEstudiante, 'Secci√≥n:', idSeccion);
        
        try {
            let url = `{{ url_for('matricula.verificar_estado_estudiante', id_estudiante=0) }}`.replace('0', idEstudiante) + `?ano_lectivo=${ano}`;
            
            // Agregar id_grado si est√° disponible en el data attribute
            const idGradoAttr = seccionOption.getAttribute('data-id-grado');
            if (idGradoAttr) {
                url += `&id_grado=${idGradoAttr}`;
                console.log('üéì Grado seleccionado:', idGradoAttr);
            }
            
            console.log('üì° Llamando a:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            console.log('üì• Respuesta del servidor:', data);
            
            if (data.success) {
                let estadoHtml = '<div id="estadoValidacion" style="margin-top: 10px; padding: 10px; border-radius: 5px; border-left: 4px solid ';
                
                if (data.tiene_registro_anterior) {
                    if (data.estado_final === 'Aprobado') {
                        estadoHtml += data.puede_matricularse ? '#28a745;"> <strong style="color: #28a745;">‚úÖ Validaci√≥n Correcta</strong>' : '#dc3545;"> <strong style="color: #dc3545;">‚ùå ERROR: Grado Incompatible</strong>';
                    } else if (data.estado_final === 'Reprobado') {
                        estadoHtml += data.puede_matricularse ? '#ffc107;"> <strong style="color: #856404;">‚ö†Ô∏è Repitiendo Grado</strong>' : '#dc3545;"> <strong style="color: #dc3545;">‚ùå ERROR: Debe Repetir</strong>';
                    } else if (data.estado_final === 'Pendiente') {
                        estadoHtml += '#dc3545;"> <strong style="color: #dc3545;">‚ùå ERROR: Estado Pendiente</strong>';
                    } else {
                        estadoHtml += '#dc3545;"> <strong style="color: #dc3545;">‚ùå ERROR: Sin Evaluar</strong>';
                    }
                    
                    estadoHtml += `<div style="margin-top: 8px; font-style: italic; font-size: 0.95em; ${data.puede_matricularse ? 'color: #28a745;' : 'color: #dc3545;'}">${data.mensaje}</div>`;
                } else {
                    estadoHtml += '#17a2b8;"> <strong style="color: #117a8b;">‚úÖ Estudiante Nuevo - Validaci√≥n OK</strong>';
                    estadoHtml += `<div style="margin-top: 8px; font-style: italic;">${data.mensaje}</div>`;
                }
                
                estadoHtml += '</div>';
                
                // Agregar o actualizar el div de validaci√≥n
                let estadoDiv = document.getElementById('estadoValidacion');
                if (estadoDiv) {
                    estadoDiv.outerHTML = estadoHtml;
                } else {
                    document.getElementById('studentDetails').insertAdjacentHTML('beforeend', estadoHtml);
                }
                
                // Deshabilitar el bot√≥n de env√≠o si no puede matricularse
                const submitButton = document.querySelector('button[type="submit"]');
                console.log('üîò Puede matricularse:', data.puede_matricularse);
                
                if (!data.puede_matricularse) {
                    submitButton.disabled = true;
                    submitButton.style.opacity = '0.5';
                    submitButton.style.cursor = 'not-allowed';
                    submitButton.title = 'No se puede matricular debido a las validaciones acad√©micas';
                    console.log('‚ùå Bot√≥n DESHABILITADO');
                } else {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                    submitButton.style.cursor = 'pointer';
                    submitButton.title = '';
                    console.log('‚úÖ Bot√≥n HABILITADO');
                }
            }
        } catch (error) {
            console.error('‚ùå Error al verificar estado:', error);
        }
    }

    // Funci√≥n para actualizar el resumen
    function updateResumen() {
        const estudianteSelect = document.getElementById('id_estudiante');
        const seccionSelect = document.getElementById('id_seccion');
        const resumenCard = document.getElementById('resumenCard');
        const resumenContent = document.getElementById('resumenContent');
        
        const estudianteText = estudianteSelect.options[estudianteSelect.selectedIndex]?.text || 'No seleccionado';
        const seccionText = seccionSelect.options[seccionSelect.selectedIndex]?.text || 'No seleccionada';
        
        if (estudianteSelect.value && seccionSelect.value) {
            resumenContent.innerHTML = `
                <div><strong>Estudiante:</strong> ${estudianteText}</div>
                <div><strong>Secci√≥n:</strong> ${seccionText}</div>
            `;
            resumenCard.style.display = 'block';
        } else {
            resumenCard.style.display = 'none';
        }
    }

    // Funci√≥n para limpiar el formulario
    function clearForm() {
        if (confirm('¬øEst√° seguro de que desea limpiar el formulario? Se perder√°n todos los datos ingresados.')) {
            document.getElementById('matriculaForm').reset();
            document.getElementById('studentInfo').classList.remove('active');
            document.getElementById('sectionInfo').classList.remove('active');
            document.getElementById('resumenCard').style.display = 'none';
        }
    }

    // Validaci√≥n y env√≠o del formulario
    document.getElementById('matriculaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validaciones b√°sicas del cliente
        const estudiante = document.getElementById('id_estudiante').value;
        const seccion = document.getElementById('id_seccion').value;
        
        if (!estudiante || !seccion) {
            Swal.fire({
                title: 'Campos incompletos',
                text: 'Por favor, complete todos los campos obligatorios.',
                icon: 'warning',
                confirmButtonColor: '#0D2C63'
            });
            return;
        }

        // Mostrar confirmaci√≥n
        const result = await Swal.fire({
            title: '{% if matricula %}Actualizar{% else %}Crear{% endif %} Matr√≠cula',
            text: '¬øEst√° seguro de que desea {% if matricula %}actualizar{% else %}crear{% endif %} esta matr√≠cula?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#059669',
            cancelButtonColor: '#d33',
            confirmButtonText: 'S√≠, {% if matricula %}actualizar{% else %}crear{% endif %}',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            // Enviar formulario
            const formData = new FormData(this);
            
            try {
                const response = await fetch('{{ request.path }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    await Swal.fire({
                        title: '¬°√âxito!',
                        text: data.mensaje,
                        icon: 'success',
                        confirmButtonColor: '#0D2C63'
                    });
                    
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    }
                } else {
                    Swal.fire({
                        title: 'Error',
                        text: data.mensaje,
                        icon: 'error',
                        confirmButtonColor: '#0D2C63'
                    });
                }
            } catch (error) {
                Swal.fire({
                    title: 'Error de conexi√≥n',
                    text: 'No se pudo completar la operaci√≥n. Por favor, intente nuevamente.',
                    icon: 'error',
                    confirmButtonColor: '#0D2C63'
                });
            }
        }
    });

    // Inicializar resumen si estamos editando
    {% if matricula %}
    document.addEventListener('DOMContentLoaded', function() {
        updateResumen();
        // Disparar eventos para mostrar informaci√≥n inicial
        document.getElementById('id_estudiante').dispatchEvent(new Event('change'));
        document.getElementById('id_seccion').dispatchEvent(new Event('change'));
    });
    {% endif %}
    // Mostrar info si ya viene seleccionado un estudiante (por URL o edici√≥n)
    document.addEventListener('DOMContentLoaded', function () {
        const estudianteSelect = document.getElementById('id_estudiante');
        if (estudianteSelect.value) {
            estudianteSelect.dispatchEvent(new Event('change'));
        }

        const seccionSelect = document.getElementById('id_seccion');
        if (seccionSelect.value) {
            seccionSelect.dispatchEvent(new Event('change'));
        }
    });

</script>
{% endblock %}