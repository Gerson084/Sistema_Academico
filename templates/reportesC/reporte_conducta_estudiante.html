{% extends "base.html" %}
{% block content %}
<style>
  @media print {
    .no-print { display: none !important; }
    .report-container { box-shadow: none !important; margin: 0 !important; }
    .section-to-hide { display: none !important; }
  }
  
  .report-container {
    max-width: 1200px;
    margin: 30px auto;
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  
  .report-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 25px;
    border-bottom: 3px solid #2563eb;
  }
  
  .report-header h2 {
    color: #1e40af;
    font-size: 28px;
    margin: 0 0 10px 0;
    font-weight: 700;
  }
  
  .report-header .subtitle {
    color: #64748b;
    font-size: 14px;
  }
  
  .student-info {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 35px;
  }
  
  .student-info h3 {
    margin: 0 0 8px 0;
    font-size: 24px;
    font-weight: 600;
  }
  
  .student-info .nie {
    font-size: 14px;
    opacity: 0.95;
  }
  
  .section-title {
    color: #1e40af;
    font-size: 20px;
    font-weight: 600;
    margin: 30px 0 20px 0;
    padding-bottom: 10px;
    border-bottom: 2px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .data-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border-radius: 8px;
    overflow: hidden;
  }
  
  .data-table thead {
    background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
    color: white;
  }
  
  .data-table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .data-table td {
    padding: 15px;
    border-bottom: 1px solid #e2e8f0;
    color: #334155;
  }
  
  .data-table tbody tr:hover {
    background-color: #f8fafc;
    transition: background-color 0.2s;
  }
  
  .data-table tbody tr:last-child td {
    border-bottom: none;
  }
  
  .nota-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 14px;
  }
  
  .nota-excelente {
    background: #dcfce7;
    color: #166534;
  }
  
  .nota-buena {
    background: #dbeafe;
    color: #1e40af;
  }
  
  .nota-regular {
    background: #fef3c7;
    color: #92400e;
  }
  
  .nota-baja {
    background: #fee2e2;
    color: #991b1b;
  }
  
  .estado-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
  }
  
  .estado-aprobado {
    background: #dcfce7;
    color: #166534;
  }
  
  .estado-reprobado {
    background: #fee2e2;
    color: #991b1b;
  }
  
  .no-data {
    text-align: center;
    padding: 40px;
    color: #64748b;
    font-style: italic;
    background: #f8fafc;
    border-radius: 8px;
    margin: 20px 0;
  }
  
  /* Estilos mejorados para el formulario de búsqueda */
  .filter-section {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    padding: 35px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 30px;
  }
  
  .filter-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #cbd5e1;
  }
  
  .filter-header h3 {
    color: #1e40af;
    font-size: 22px;
    font-weight: 700;
    margin: 0;
  }
  
  .filter-icon {
    font-size: 28px;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    color: #334155;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #cbd5e1;
    border-radius: 8px;
    font-size: 15px;
    background: white;
    transition: all 0.3s;
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 20px;
    padding-right: 45px;
  }
  
  .form-group select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .form-group select:hover {
    border-color: #3b82f6;
  }
  
  .btn-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 25px;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    padding: 14px 35px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
  }
  
  .btn-primary:active {
    transform: translateY(0);
  }
  
  .btn-download {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
    margin-right: 10px;
  }
  
  .btn-download:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
  }

  .btn-download-periodo {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
    margin-right: 10px;
  }
  
  .btn-download-periodo:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
  }

  .btn-download-all {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);
  }
  
  .btn-download-all:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
  }
  
  .btn-ver {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    color: white;
    border: none;
    padding: 8px 18px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-ver:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
    color: white;
  }
  
  .error-message {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    padding: 18px 24px;
    border-radius: 10px;
    margin: 20px 0;
    border-left: 5px solid #dc2626;
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.15);
  }
  
  .actions-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
    gap: 10px;
  }
  
  .results-section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    margin-top: 25px;
  }
  
  .results-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    color: #1e40af;
  }
  
  .results-header h4 {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
  }
  
  .info-card {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 25px;
    border-left: 4px solid #3b82f6;
  }
  
  .info-card p {
    margin: 0;
    color: #1e40af;
    font-size: 14px;
  }
  
  .divider {
    height: 2px;
    background: linear-gradient(90deg, transparent, #cbd5e1, transparent);
    margin: 30px 0;
  }
  
  .search-box {
    margin-bottom: 20px;
    position: relative;
  }
  
  .search-box input {
    width: 100%;
    padding: 12px 45px 12px 16px;
    border: 2px solid #cbd5e1;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s;
  }
  
  .search-box input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .search-box input::placeholder {
    color: #94a3b8;
  }
  
  .search-icon {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #64748b;
    font-size: 18px;
  }
  
  .highlight {
    background-color: #fef3c7;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: 600;
  }

  .btn-back {
    background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 6px rgba(100, 116, 139, 0.3);
    text-decoration: none;
    display: inline-block;
  }
  
  .btn-back:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(100, 116, 139, 0.4);
    color: white;
  }
</style>

<div class="report-container">
  {% if not estudiante %}
    <div class="report-header">
      <h2>🎓 Reporte de Conducta del Estudiante</h2>
      <p class="subtitle">Sistema de Gestión Académica</p>
    </div>
    
    <div class="filter-section">
      <div class="filter-header">
        <span class="filter-icon">🔍</span>
        <h3>Buscar Estudiantes</h3>
      </div>
      
      <div class="info-card">
        <p>📋 Selecciona los filtros para buscar estudiantes y generar reportes de conducta</p>
      </div>
      
      <form method="get">
        <div class="form-grid">
          <div class="form-group">
            <label for="grado_id">📚 Grado</label>
            <select name="grado_id" id="grado_id">
              <option value="">-- Todos los grados --</option>
              {% for g in assigned_grados %}
                <option value="{{ g.id_grado }}">{{ g.nombre_grado }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="seccion_id">📖 Sección</label>
            <select name="seccion_id" id="seccion_id">
              <option value="">-- Todas las secciones --</option>
              {% for s in assigned_secciones %}
                <option value="{{ s.id_seccion }}">{{ s.nombre_seccion }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="btn-container">
          <button type="submit" class="btn-primary">🔎 Buscar Estudiantes</button>
        </div>
      </form>

      {% if estudiantes_list is defined %}
        <div class="divider"></div>
        
        <div class="results-section">
          <div class="results-header">
            <span>📊</span>
            <h4>Resultados de la Búsqueda</h4>
          </div>
          
          {% if estudiantes_list %}
            <div class="search-box">
              <input 
                type="text" 
                id="searchInput" 
                placeholder="🔍 Buscar por NIE o nombre del estudiante..." 
                onkeyup="filterTable()"
              />
              <span class="search-icon">🔍</span>
            </div>
            
            <table class="data-table" id="estudiantesTable">
              <thead>
                <tr>
                  <th>🆔 NIE</th>
                  <th>👤 Estudiante</th>
                  <th style="text-align: center;">⚙️ Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for e in estudiantes_list %}
                  <tr>
                    <td><strong class="nie-field">{{ e.nie }}</strong></td>
                    <td class="nombre-field">{{ e.apellidos }}, {{ e.nombres }}</td>
                    <td style="text-align: center;">
                      <a href="{{ url_for('reportes.reporte_conducta_estudiante') }}?estudiante_id={{ e.id_estudiante }}" class="btn-ver">
                        📄 Ver Reporte
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            
            <div id="noResults" class="no-data" style="display: none;">
              😕 No se encontraron estudiantes que coincidan con tu búsqueda
            </div>
          {% else %}
            <div class="no-data">
              😕 No se encontraron estudiantes para los filtros seleccionados
            </div>
          {% endif %}
        </div>
      {% endif %}
      
      {% if estudiante_not_found %}
        <div class="error-message">
          ❌ No se encontró el estudiante con ID {{ estudiante_id }}
        </div>
      {% endif %}
      
      {% if acceso_denegado %}
        <div class="error-message">
          🚫 Acceso denegado: no tienes permisos para ver la información de este estudiante o no está en tus asignaciones.
        </div>
      {% endif %}
    </div>
  {% else %}
    <div class="no-print actions-bar">
      <a href="{{ url_for('reportes.reporte_conducta_estudiante') }}" class="btn-back">
        ⬅️ Volver
      </a>
      <button onclick="imprimirAnual()" class="btn-download">
        📥 Imprimir Anual
      </button>
      <button onclick="imprimirPeriodo()" class="btn-download-periodo">
        📥 Imprimir Por Periodo
      </button>
      <button onclick="imprimirTodo()" class="btn-download-all">
        📥 Imprimir Todo
      </button>
    </div>
    
    <div class="report-header">
      <h2>📋 Reporte de Conducta del Estudiante</h2>
      <p class="subtitle">Sistema de Gestión Académica</p>
    </div>
    
    <div class="student-info">
      <h3>👤 {{ estudiante.nombres }} {{ estudiante.apellidos }}</h3>
      <p class="nie">🆔 NIE: {{ estudiante.nie }}</p>
    </div>
    
    <div id="seccionPeriodo">
      <h4 class="section-title">
        <span>📊</span>
        Promedios por Periodo
      </h4>
      {% if periodos %}
        <table class="data-table">
          <thead>
            <tr>
              <th>📅 Periodo</th>
              <th>🗓️ Fecha de Cálculo</th>
              <th>⭐ Nota Actitud / Conducta</th>
            </tr>
          </thead>
          <tbody>
            {% for p in periodos %}
            <tr>
              <td><strong>{{ p.calificacion.periodo.nombre if p.calificacion and p.calificacion.periodo else (p.calificacion.id_periodo if p.calificacion else '-') }}</strong></td>
              <td>{{ p.fecha_calculo.strftime('%d/%m/%Y') if p.fecha_calculo else '-' }}</td>
              <td>
                {% set nota = p.nota_actitud|float %}
                <span class="nota-badge {% if nota >= 9 %}nota-excelente{% elif nota >= 7 %}nota-buena{% elif nota >= 6 %}nota-regular{% else %}nota-baja{% endif %}">
                  {{ "%.2f"|format(nota) }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="no-data">
          📭 No hay promedios por periodo registrados para este estudiante
        </div>
      {% endif %}
    </div>
    
    <div id="seccionAnual">
      <h4 class="section-title">
        <span>📈</span>
        Promedios Anuales
      </h4>
      {% if anuales %}
        <table class="data-table">
          <thead>
            <tr>
              <th>📅 Periodo</th>
              <th>🗓️ Fecha de Cálculo</th>
              <th>🎯 Promedio Final</th>
              <th>⭐ Conducta Final</th>
              <th>✅ Estado</th>
            </tr>
          </thead>
          <tbody>
            {% for a in anuales %}
            <tr>
              <td><strong>{{ a.periodo.nombre if a.periodo else a.id_periodo }}</strong></td>
              <td>{{ a.fecha_calculo.strftime('%d/%m/%Y') if a.fecha_calculo else '-' }}</td>
              <td>
                {% set promedio = a.promedio_final|float %}
                <span class="nota-badge {% if promedio >= 9 %}nota-excelente{% elif promedio >= 7 %}nota-buena{% elif promedio >= 6 %}nota-regular{% else %}nota-baja{% endif %}">
                  {{ "%.2f"|format(promedio) }}
                </span>
              </td>
              <td>{{ a.conducta_final }}</td>
              <td>
                <span class="estado-badge {% if a.estado_final|lower == 'aprobado' %}estado-aprobado{% else %}estado-reprobado{% endif %}">
                  {{ a.estado_final }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="no-data">
          📭 No hay promedios anuales registrados para este estudiante
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
function filterTable() {
  const input = document.getElementById('searchInput');
  const filter = input.value.toLowerCase().trim();
  const table = document.getElementById('estudiantesTable');
  const tbody = table.getElementsByTagName('tbody')[0];
  const rows = tbody.getElementsByTagName('tr');
  const noResults = document.getElementById('noResults');
  
  let visibleCount = 0;
  
  for (let i = 0; i < rows.length; i++) {
    const nieField = rows[i].querySelector('.nie-field');
    const nombreField = rows[i].querySelector('.nombre-field');
    
    if (nieField && nombreField) {
      const nieText = nieField.textContent.toLowerCase();
      const nombreText = nombreField.textContent.toLowerCase();
      
      if (nieText.includes(filter) || nombreText.includes(filter)) {
        rows[i].style.display = '';
        visibleCount++;
      } else {
        rows[i].style.display = 'none';
      }
    }
  }
  
  // Mostrar/ocultar mensaje de "no hay resultados"
  if (visibleCount === 0) {
    table.style.display = 'none';
    noResults.style.display = 'block';
  } else {
    table.style.display = 'table';
    noResults.style.display = 'none';
  }
}

function imprimirAnual() {
  // Ocultar sección de periodo
  document.getElementById('seccionPeriodo').classList.add('section-to-hide');
  document.getElementById('seccionAnual').classList.remove('section-to-hide');
  
  // Imprimir
  window.print();
  
  // Restaurar visibilidad después de imprimir
  setTimeout(() => {
    document.getElementById('seccionPeriodo').classList.remove('section-to-hide');
  }, 100);
}

function imprimirPeriodo() {
  // Ocultar sección anual
  document.getElementById('seccionAnual').classList.add('section-to-hide');
  document.getElementById('seccionPeriodo').classList.remove('section-to-hide');
  
  // Imprimir
  window.print();
  
  // Restaurar visibilidad después de imprimir
  setTimeout(() => {
    document.getElementById('seccionAnual').classList.remove('section-to-hide');
  }, 100);
}

function imprimirTodo() {
  // Mostrar ambas secciones
  document.getElementById('seccionPeriodo').classList.remove('section-to-hide');
  document.getElementById('seccionAnual').classList.remove('section-to-hide');
  
  // Imprimir
  window.print();
}
</script>
{% endblock %}