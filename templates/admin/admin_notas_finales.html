{% extends "base.html" %}

{% block content %}
<style>
    .page-header {
        background: linear-gradient(135deg, #0D2C63 0%, #1a4480 100%);
        color: #E9E2C3;
        padding: 2rem;
        border-radius: 0.75rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .filter-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }

    .filter-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0D2C63;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-select, .form-control {
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.75rem;
        transition: all 0.3s;
    }

    .form-select:focus, .form-control:focus {
        border-color: #0D2C63;
        box-shadow: 0 0 0 3px rgba(13, 44, 99, 0.1);
    }

    .btn-filter {
        background: #0D2C63;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-filter:hover {
        background: #1a4480;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(13, 44, 99, 0.3);
    }

    .info-box {
        background: #f0f9ff;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
    }

    .table-responsive {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background: #f9fafb;
        color: #0D2C63;
        font-weight: 600;
        border-bottom: 2px solid #e5e7eb;
        text-align: center;
        vertical-align: middle;
        padding: 1rem 0.5rem;
        font-size: 0.9rem;
    }

    .table tbody td {
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
        text-align: center;
    }

    .table tbody td.student-name {
        text-align: left;
        font-weight: 500;
    }

    .nota-badge {
        display: inline-block;
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-weight: 600;
        min-width: 50px;
    }

    .nota-badge.aprobado {
        background: #d1fae5;
        color: #065f46;
    }

    .nota-badge.reprobado {
        background: #fee2e2;
        color: #991b1b;
    }

    .nota-badge.sin-nota {
        background: #f3f4f6;
        color: #6b7280;
    }

    .promedio-final {
        background: #dbeafe;
        color: #1e40af;
        font-weight: 700;
        font-size: 1.1rem;
    }

    .conducta-badge {
        font-size: 0.9rem;
        color: #6b7280;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #d1d5db;
    }
</style>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="bi bi-clipboard-data"></i>
            Consulta de Notas Finales - Área Administrativa
        </h1>
        <p class="mb-0 mt-2" style="opacity: 0.9;">Visualización de registros académicos completos</p>
    </div>

    <!-- Filtros -->
    <div class="filter-card">
        <h3 class="filter-section-title">
            <i class="bi bi-funnel"></i>
            Filtros de Búsqueda
        </h3>

        <form method="GET" action="{{ url_for('admin_notas.admin_notas_finales') }}">
            <div class="row g-3">
                <!-- Año Lectivo -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-calendar3"></i> Año Lectivo
                    </label>
                    <select name="ano_lectivo" class="form-select" onchange="this.form.submit()">
                        <option value="">Seleccione un año</option>
                        {% for ano in anos_lectivos %}
                        <option value="{{ ano.id_ano_lectivo }}" 
                                {% if ano.id_ano_lectivo == id_ano_lectivo %}selected{% endif %}>
                            {{ ano.ano }} {% if ano.activo %}⭐ Actual{% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Sección -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-layout-text-sidebar"></i> Sección
                    </label>
                    <select name="seccion" class="form-select" onchange="this.form.submit()" 
                            {% if not id_ano_lectivo %}disabled{% endif %}>
                        <option value="">Seleccione una sección</option>
                        {% for seccion in secciones %}
                        <option value="{{ seccion.id_seccion }}" 
                                {% if seccion.id_seccion == id_seccion %}selected{% endif %}>
                            {{ seccion.grado.nombre_grado }} - Sección {{ seccion.nombre_seccion }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Asignación (Materia) -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">
                        <i class="bi bi-journal-text"></i> Materia
                    </label>
                    <select name="asignacion" class="form-select" onchange="this.form.submit()" 
                            {% if not id_seccion %}disabled{% endif %}>
                        <option value="">Seleccione una materia</option>
                        {% for asig in asignaciones %}
                        <option value="{{ asig.id_asignacion }}" 
                                {% if asig.id_asignacion == id_asignacion %}selected{% endif %}>
                            {{ asig.nombre_materia }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <!-- Información de la Asignación -->
    {% if info_asignacion %}
    <div class="info-box">
        <div class="row">
            <div class="col-md-6">
                <strong><i class="bi bi-journal-text"></i> Materia:</strong> 
                {{ info_asignacion.nombre_materia }} ({{ info_asignacion.codigo_materia }})
            </div>
            <div class="col-md-6">
                <strong><i class="bi bi-person-badge"></i> Docente:</strong> 
                {{ info_asignacion.docente }}
            </div>
            <div class="col-md-6 mt-2">
                <strong><i class="bi bi-building"></i> Grado/Sección:</strong> 
                {{ info_asignacion.grado }} - {{ info_asignacion.seccion }}
            </div>
            <div class="col-md-6 mt-2">
                <strong><i class="bi bi-calendar3"></i> Año Lectivo:</strong> 
                {{ info_asignacion.ano_lectivo }}
            </div>
        </div>
    </div>

    <!-- Tabla de Notas -->
    <div class="table-responsive">
        <h5 class="mb-3 fw-bold" style="color: #0D2C63;">
            <i class="bi bi-table"></i> Notas Finales por Período
        </h5>
        
        {% if estudiantes %}
        <table class="table table-hover">
            <thead>
                <tr>
                    <th style="width: 80px;">NIE</th>
                    <th style="text-align: left;">Estudiante</th>
                    {% for periodo in periodos %}
                    <th>{{ periodo.nombre_periodo }}</th>
                    {% endfor %}
                    <th style="background: #dbeafe;">Promedio Anual</th>
                </tr>
            </thead>
            <tbody>
                {% for estudiante in estudiantes %}
                <tr>
                    <td><strong>{{ estudiante.nie }}</strong></td>
                    <td class="student-name">{{ estudiante.nombre_completo }}</td>
                    
                    {% for i in range(periodos|length) %}
                    <td>
                        {% if estudiante.notas_por_periodo[i] is not none %}
                            {% set nota = estudiante.notas_por_periodo[i] %}
                            <span class="nota-badge {% if nota >= 6.0 %}aprobado{% else %}reprobado{% endif %}">
                                {{ "%.1f"|format(nota) }}
                            </span>
                            {% if estudiante.conductas_por_periodo[i] is not none %}
                            <div class="conducta-badge mt-1">
                                <small><i class="bi bi-star"></i> {{ estudiante.conductas_por_periodo[i] }}</small>
                            </div>
                            {% endif %}
                        {% else %}
                            <span class="nota-badge sin-nota">--</span>
                        {% endif %}
                    </td>
                    {% endfor %}
                    
                    <td>
                        {% if estudiante.promedio_anual is not none %}
                            <span class="nota-badge promedio-final">
                                {{ "%.2f"|format(estudiante.promedio_anual) }}
                            </span>
                        {% else %}
                            <span class="nota-badge sin-nota">--</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-inbox"></i>
            <p>No hay estudiantes registrados en esta asignación</p>
        </div>
        {% endif %}
    </div>

    {% elif id_asignacion %}
    <div class="empty-state">
        <i class="bi bi-exclamation-circle"></i>
        <h5>No se encontró información para la asignación seleccionada</h5>
        <p class="mt-3"><strong>DEBUG:</strong></p>
        <p>ID Asignación: {{ id_asignacion }}</p>
        <p>Año Lectivo: {{ id_ano_lectivo }}</p>
        <p>Sección: {{ id_seccion }}</p>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-funnel"></i>
        <h5>Seleccione los filtros para consultar las notas</h5>
        <p>Use los filtros superiores para seleccionar año lectivo, grado, sección y materia</p>
        {% if id_ano_lectivo %}
        <p class="mt-3"><strong>Año seleccionado:</strong> {{ id_ano_lectivo }}</p>
        <p><strong>Secciones disponibles:</strong> {{ secciones|length }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    // Auto-submit al cambiar los filtros principales
    document.addEventListener('DOMContentLoaded', function() {
        const selects = document.querySelectorAll('.form-select');
        selects.forEach(select => {
            select.addEventListener('change', function() {
                // Solo submit si no está deshabilitado
                if (!this.disabled) {
                    this.form.submit();
                }
            });
        });
    });
</script>

{% endblock %}
