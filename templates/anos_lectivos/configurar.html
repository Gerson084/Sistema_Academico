{% extends "base.html" %}

{% block content %}
<style>
    :root {
        --primary-blue: #0D2C63;
        --light-cream: #E9E2C3;
        --success-green: #059669;
        --warning-orange: #f59e0b;
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary-blue) 0%, #1a4480 100%);
        color: var(--light-cream);
        padding: 2rem;
        margin-bottom: 2rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .config-section {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-blue);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .badge-completado { background: #dcfce7; color: #166534; }
    .badge-pendiente { background: #fef3c7; color: #92400e; }

    .periodo-item {
        background: #f9fafb;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .form-control {
        width: 100%;
        padding: 0.6rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 0.95rem;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-blue);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary { background: var(--success-green); color: white; }
    .btn-warning { background: var(--warning-orange); color: white; }
    .btn-secondary { background: #6b7280; color: white; }

    .btn:hover { transform: translateY(-2px); opacity: 0.9; }

    .info-box {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
</style>

<div class="container-fluid mt-4">
    <div class="page-header">
        <h1 style="font-size: 2rem; font-weight: 700; margin: 0;">
            <i class="bi bi-gear"></i>
            Configurar Año Lectivo {{ ano.ano }}
        </h1>
        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">
            {{ ano.fecha_inicio.strftime('%d/%m/%Y') if ano.fecha_inicio else 'Sin fecha' }} - 
            {{ ano.fecha_fin.strftime('%d/%m/%Y') if ano.fecha_fin else 'Sin fecha' }}
        </p>
    </div>

    <!-- Sección 1: Crear Períodos -->
    <div class="config-section">
        <div class="section-title">
            <i class="bi bi-calendar-week"></i>
            1. Períodos Académicos
            {% if tiene_periodos %}
                <span class="status-badge badge-completado">
                    <i class="bi bi-check-circle-fill"></i> Completado
                </span>
            {% else %}
                <span class="status-badge badge-pendiente">
                    <i class="bi bi-clock"></i> Pendiente
                </span>
            {% endif %}
        </div>

        {% if not tiene_periodos %}
            <div class="info-box">
                <i class="bi bi-info-circle"></i>
                Define los 4 períodos académicos para este año lectivo.
            </div>

            <div id="periodosContainer">
                {% for i in range(1, 5) %}
                <div class="periodo-item">
                    <div style="flex: 1; margin-right: 1rem;">
                        <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.5rem;">
                            Período {{ i }}
                        </label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <input type="date" class="form-control fecha-inicio" placeholder="Fecha inicio" required>
                            <input type="date" class="form-control fecha-fin" placeholder="Fecha fin" required>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button class="btn btn-primary" onclick="crearPeriodos()">
                <i class="bi bi-check-circle"></i> Crear Períodos
            </button>
        {% else %}
            <p style="color: #059669; display: flex; align-items: center; gap: 0.5rem;">
                <i class="bi bi-check-circle-fill"></i>
                Este año tiene {{ total_periodos }} períodos configurados
            </p>
            {% if not ano.activo %}
            <button class="btn btn-secondary" onclick="editarPeriodos()" style="margin-top: 0.5rem;">
                <i class="bi bi-pencil"></i> Editar Períodos
            </button>
            {% endif %}
        {% endif %}
    </div>

    <!-- Sección 2: Crear Secciones -->
    <div class="config-section">
        <div class="section-title">
            <i class="bi bi-grid-3x3"></i>
            2. Secciones
            {% if tiene_secciones %}
                <span class="status-badge badge-completado">
                    <i class="bi bi-check-circle-fill"></i> Completado
                </span>
            {% else %}
                <span class="status-badge badge-pendiente">
                    <i class="bi bi-clock"></i> Pendiente
                </span>
            {% endif %}
        </div>

        {% if not tiene_secciones %}
            <div class="info-box">
                <i class="bi bi-info-circle"></i>
                Crea las secciones académicas para este año lectivo. Las secciones son necesarias para matricular estudiantes.
            </div>

            <a href="{{ url_for('secciones.nueva_seccion') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Crear Secciones
            </a>
        {% else %}
            <p style="color: #059669; display: flex; align-items: center; gap: 0.5rem;">
                <i class="bi bi-check-circle-fill"></i>
                Este año tiene {{ total_secciones }} secciones configuradas
            </p>
            <a href="{{ url_for('secciones.lista_secciones') }}" class="btn btn-secondary" style="margin-top: 0.5rem;">
                <i class="bi bi-eye"></i> Ver Secciones
            </a>
        {% endif %}
    </div>

    <!-- Sección 3: Activar Año -->
    <div class="config-section">
        <div class="section-title">
            <i class="bi bi-power"></i>
            3. Activación del Año
        </div>

        {% if ano.activo %}
            <p style="color: #059669; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                <i class="bi bi-check-circle-fill"></i>
                Este año está ACTIVO
            </p>
        {% else %}
            <div class="info-box">
                <i class="bi bi-info-circle"></i>
                Una vez configurados los períodos, puedes activar este año. 
                Esto desactivará automáticamente los demás años.
            </div>

            {% if tiene_periodos %}
                <button class="btn btn-primary" onclick="activarAno()">
                    <i class="bi bi-check-circle"></i> Activar Año {{ ano.ano }}
                </button>
            {% else %}
                <p style="color: #6b7280;">
                    <i class="bi bi-info-circle"></i>
                    Completa la configuración de períodos antes de activar
                </p>
            {% endif %}
        {% endif %}
    </div>

    <!-- Sección 4: Cerrar Año Lectivo -->
    {% if ano.activo %}
    <div class="config-section" style="border: 2px solid #dc2626;">
        <div class="section-title" style="color: #dc2626;">
            <i class="bi bi-lock"></i>
            4. Cerrar Año Lectivo
        </div>

        <div class="info-box" style="background: #fef2f2; border-left-color: #dc2626;">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>¡Atención!</strong> Cerrar el año lectivo realizará las siguientes acciones:
            <ul style="margin: 0.5rem 0 0 1.5rem;">
                <li>Verificará que todos los estudiantes tengan estado final (Aprobado/Reprobado)</li>
                <li>Desactivará todas las matrículas del año</li>
                <li>Desactivará el año lectivo</li>
                <li>Esta acción es <strong>irreversible</strong></li>
            </ul>
        </div>

        <button class="btn btn-warning" onclick="cerrarAno()" style="background: #dc2626; border-color: #dc2626;">
            <i class="bi bi-lock-fill"></i> Cerrar Año {{ ano.ano }}
        </button>
    </div>
    {% endif %}

    <!-- Botón volver -->
    <a href="{{ url_for('anos_lectivos.listar_anos') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver a la lista
    </a>
</div>

<script>
function crearPeriodos() {
    const periodos = [];
    const items = document.querySelectorAll('.periodo-item');
    
    items.forEach((item, index) => {
        const fechaInicio = item.querySelector('.fecha-inicio').value;
        const fechaFin = item.querySelector('.fecha-fin').value;
        
        if (!fechaInicio || !fechaFin) {
            Swal.fire({
                icon: 'error',
                title: 'Datos incompletos',
                text: `Completa las fechas del período ${index + 1}`,
                confirmButtonColor: '#0D2C63'
            });
            throw new Error('Datos incompletos');
        }

        if (new Date(fechaFin) <= new Date(fechaInicio)) {
            Swal.fire({
                icon: 'error',
                title: 'Error de validación',
                text: `La fecha de fin del período ${index + 1} debe ser posterior a la de inicio`,
                confirmButtonColor: '#0D2C63'
            });
            throw new Error('Fechas inválidas');
        }

        periodos.push({
            numero: index + 1,
            nombre: `Período ${index + 1}`,
            fecha_inicio: fechaInicio,
            fecha_fin: fechaFin
        });
    });

    // Confirmar creación
    Swal.fire({
        title: '¿Crear períodos?',
        text: `Se crearán 4 períodos para el año {{ ano.ano }}`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#059669',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, crear',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/anos-lectivos/crear-periodos/{{ ano.id_ano_lectivo }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ periodos: periodos })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Creado!',
                        text: data.mensaje,
                        confirmButtonColor: '#0D2C63'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.mensaje,
                        confirmButtonColor: '#0D2C63'
                    });
                }
            });
        }
    });
}

async function editarPeriodos() {
    // Obtener períodos actuales
    const response = await fetch('/anos-lectivos/obtener-periodos/{{ ano.id_ano_lectivo }}');
    const data = await response.json();
    
    if (!data.success) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.mensaje,
            confirmButtonColor: '#0D2C63'
        });
        return;
    }
    
    const periodos = data.periodos;
    
    // Crear HTML con inputs para cada período
    let periodosHTML = '<div style="text-align: left;">';
    periodos.forEach((p, index) => {
        periodosHTML += `
            <div style="margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 0.5rem;">
                    ${p.nombre_periodo}
                </label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <div>
                        <label style="font-size: 0.8rem; color: #6b7280;">Fecha Inicio:</label>
                        <input type="date" id="fecha_inicio_${p.id_periodo}" value="${p.fecha_inicio}" 
                               class="swal2-input" style="margin: 0.25rem 0 0 0;">
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: #6b7280;">Fecha Fin:</label>
                        <input type="date" id="fecha_fin_${p.id_periodo}" value="${p.fecha_fin}" 
                               class="swal2-input" style="margin: 0.25rem 0 0 0;">
                    </div>
                </div>
            </div>
        `;
    });
    periodosHTML += '</div>';
    
    Swal.fire({
        title: 'Editar Períodos',
        html: periodosHTML,
        width: '600px',
        showCancelButton: true,
        confirmButtonColor: '#059669',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Guardar Cambios',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            const periodosActualizados = [];
            
            periodos.forEach(p => {
                const fechaInicio = document.getElementById(`fecha_inicio_${p.id_periodo}`).value;
                const fechaFin = document.getElementById(`fecha_fin_${p.id_periodo}`).value;
                
                if (!fechaInicio || !fechaFin) {
                    Swal.showValidationMessage('Completa todas las fechas');
                    return false;
                }
                
                if (new Date(fechaFin) <= new Date(fechaInicio)) {
                    Swal.showValidationMessage(`La fecha fin de ${p.nombre_periodo} debe ser posterior a la de inicio`);
                    return false;
                }
                
                periodosActualizados.push({
                    id_periodo: p.id_periodo,
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin
                });
            });
            
            return periodosActualizados;
        }
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            fetch('/anos-lectivos/actualizar-periodos/{{ ano.id_ano_lectivo }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ periodos: result.value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Actualizado!',
                        text: data.mensaje,
                        confirmButtonColor: '#0D2C63'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.mensaje,
                        confirmButtonColor: '#0D2C63'
                    });
                }
            });
        }
    });
}

function activarAno() {
    Swal.fire({
        title: '¿Activar año {{ ano.ano }}?',
        text: 'Se desactivarán los demás años lectivos',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#059669',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, activar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch('/anos-lectivos/activar/{{ ano.id_ano_lectivo }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Activado!',
                        text: data.mensaje,
                        confirmButtonColor: '#0D2C63'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.mensaje,
                        confirmButtonColor: '#0D2C63'
                    });
                }
            });
        }
    });
}

function cerrarAno() {
    Swal.fire({
        title: '¿Cerrar año {{ ano.ano }}?',
        html: `
            <div style="text-align: left; padding: 1rem;">
                <p><strong>Esta acción:</strong></p>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
                    <li>Verificará que todos los estudiantes tengan estado final</li>
                    <li>Desactivará todas las matrículas del año</li>
                    <li>Desactivará el año lectivo</li>
                    <li><strong>NO se puede revertir</strong></li>
                </ul>
                <p style="margin-top: 1rem; color: #dc2626;"><strong>¿Estás completamente seguro?</strong></p>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Sí, cerrar año',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Cerrando año...',
                text: 'Por favor espera',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch('/anos-lectivos/cerrar-ano/{{ ano.id_ano_lectivo }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Año cerrado exitosamente!',
                        html: `
                            <div style="text-align: left; padding: 1rem;">
                                <p><strong>Resumen del cierre:</strong></p>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    <li>Total matrículas: <strong>${data.estadisticas.total_matriculas}</strong></li>
                                    <li>Aprobados: <strong style="color: #059669;">${data.estadisticas.aprobados}</strong></li>
                                    <li>Reprobados: <strong style="color: #dc2626;">${data.estadisticas.reprobados}</strong></li>
                                </ul>
                                <p style="margin-top: 1rem;">${data.mensaje}</p>
                            </div>
                        `,
                        confirmButtonColor: '#0D2C63'
                    }).then(() => {
                        window.location.href = '/anos-lectivos';
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al cerrar año',
                        text: data.mensaje,
                        confirmButtonColor: '#0D2C63'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo cerrar el año lectivo',
                    confirmButtonColor: '#0D2C63'
                });
            });
        }
    });
}
</script>

{% endblock %}
